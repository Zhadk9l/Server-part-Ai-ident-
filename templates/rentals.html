<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–û—Ä–µ–Ω–¥–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-container .form-select,
        .filter-container .form-control {
            width: 180px;
        }
        .modal-dialog {
            max-width: 525px;
        }
        .modal-body img {
            width: 150px;
            margin: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        .modal-body img:hover {
            opacity: 0.8;
        }
        .photo-section {
            margin-top: 20px;
        }
        .photo-section h6 {
            margin-bottom: 10px;
        }
        .damage-list ul {
            padding-left: 20px;
        }
        .rental-info {
            margin-bottom: 10px;
        }
        .rental-info span {
            font-weight: bold;
        }
        .user-name {
            font-weight: normal;
            font-size: 16px;
        }
        .date {
            font-size: 14px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        .damage-flag {
        background-color: #ffcccc !important;
        }
    </style>

</head>

<body>

<div class="container mt-5">
    <div class="d-flex justify-content-between mb-4">
        <h1>üìÑ –û—Ä–µ–Ω–¥–∏</h1>
        <div>
            <a href="/admin/add_rental" class="btn btn-warning">‚ûï –î–æ–¥–∞—Ç–∏ –æ—Ä–µ–Ω–¥—É</a>
            <a href="/admin/panel" class="btn btn-secondary ms-2">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</a>
        </div>
    </div>

    <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
    <div class="filter-container">
        <div>
            <label for="statusFilter" class="form-label">–°—Ç–∞—Ç—É—Å</label>
            <select id="statusFilter" class="form-select" onchange="searchTable()">
                <option value="all">–í—Å—ñ –æ—Ä–µ–Ω–¥–∏</option>
                <option value="–∞–∫—Ç–∏–≤–Ω–∞">–ê–∫—Ç–∏–≤–Ω—ñ –æ—Ä–µ–Ω–¥–∏</option>
                <option value="–∑–∞–≤–µ—Ä—à–µ–Ω–æ">–ó–∞–≤–µ—Ä—à–µ–Ω—ñ –æ—Ä–µ–Ω–¥–∏</option>
            </select>
        </div>
        <div>
            <label for="startDateFilter" class="form-label">–ü–æ—á–∞—Ç–æ–∫</label>
            <input type="date" id="startDateFilter" class="form-control" onchange="searchTable()">
        </div>
        <div>
            <label for="endDateFilter" class="form-label">–ö—ñ–Ω–µ—Ü—å</label>
            <input type="date" id="endDateFilter" class="form-control" onchange="searchTable()">
        </div>
        <div>
            <label for="searchInput" class="form-label">–ü–æ—à—É–∫</label>
            <input type="text" id="searchInput" onkeyup="searchTable()" class="form-control" placeholder="üîç –ü–æ—à—É–∫ –ø–æ —Ñ–∞–º—ñ–ª—ñ—ó –∞–±–æ –Ω–æ–º–µ—Ä—É –º–∞—à–∏–Ω–∏">
        </div>
    </div>

    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-hover" id="rentalsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                    <th>–ê–≤—Ç–æ</th>
                    <th>–ü–æ—á–∞—Ç–æ–∫</th>
                    <th>–ö—ñ–Ω–µ—Ü—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î—ñ—ó</th>
                </tr>
            </thead>
            <tbody>
                {% for rental in rentals %}
                <tr>
                    <td>{{ rental.rental_id }}</td>
                    <td>{{ rental.user.first_name }} {{ rental.user.last_name }}</td>
                    <td>{{ rental.car.license_plate }}</td>
                    <td>{{ rental.rental_start }}</td>
                    <td>{{ rental.rental_end }}</td>
                    <td>
                        {% if rental.has_new_damage and not rental.is_ended %}
                            {{'üî¥ –ê–∫—Ç–∏–≤–Ω–∞ (–∑ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è–º)'}}
                        {% else %}
                            {{ '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' if rental.is_ended else '–ê–∫—Ç–∏–≤–Ω–∞' }}
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="openModal({{ rental.rental_id }})">–î–µ—Ç–∞–ª—å–Ω–æ</button>
                        <button class="btn btn-sm btn-warning ms-1" onclick="openEditModal({{ rental.rental_id }}, '{{ rental.rental_end }}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó -->
<div class="modal fade" id="rentalModal" tabindex="-1" aria-labelledby="rentalModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rentalModalLabel">–î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ—Ä–µ–Ω–¥—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
      </div>
      <div class="modal-body" id="rentalDetails">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ –ø—ñ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É —Ñ–æ—Ç–æ -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-transparent border-0">
      <canvas id="photoCanvas" style="width: 100%; border-radius:10px;"></canvas>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–∞—Ç–∏ -->
<div class="modal fade" id="editRentalModal" tabindex="-1" aria-labelledby="editRentalModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editRentalForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editRentalModalLabel">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ—Ä–µ–Ω–¥—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="newEndDate" class="form-label">–ù–æ–≤–∞ –¥–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –æ—Ä–µ–Ω–¥–∏</label>
          <input type="datetime-local" id="newEndDate" name="newEndDate" class="form-control" required>
        </div>
        <input type="hidden" id="editRentalId" name="rental_id">
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </form>
  </div>
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è after-—Ñ–æ—Ç–æ -->
<div class="modal fade" id="uploadAfterPhotosModal" tabindex="-1" aria-labelledby="uploadAfterPhotosLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="uploadAfterPhotosForm">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadAfterPhotosLabel">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ –ø—ñ—Å–ª—è –æ—Ä–µ–Ω–¥–∏</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="uploadRentalId" name="rental_id" value="">
          <div id="photoInputsContainer">
            <!-- 8 —ñ–Ω–ø—É—Ç—ñ–≤ –¥–ª—è —Ñ–æ—Ç–æ -->
            <div class="mb-3">
              <label for="photo1" class="form-label">–§–æ—Ç–æ –ª–æ–±–æ–≤–æ–≥–æ —Å–∫–ª–∞</label>
              <input class="form-control" type="file" id="photo1" name="photo1" accept="image/*" required>
            </div>
            <div class="mb-3">
              <label for="photo2" class="form-label">–§–æ—Ç–æ –ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –±–∞–º–ø–µ—Ä–∞ </label>
              <input class="form-control" type="file" id="photo2" name="photo2" accept="image/*" required>
            </div>
            <div class="mb-3">
              <label for="photo3" class="form-label">–§–æ—Ç–æ –ª—ñ–≤–æ–≥–æ –∫—Ä–∏–ª–∞</label>
              <input class="form-control" type="file" id="photo3" name="photo3" accept="image/*" required>
            </div>
            <div class="mb-3">
              <label for="photo4" class="form-label">–§–æ—Ç–æ –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∏–ª–∞</label>
              <input class="form-control" type="file" id="photo4" name="photo4" accept="image/*" required>
            </div>
            <div class="mb-3">
              <label for="photo5" class="form-label">–§–æ—Ç–æ –ª—ñ–≤–∏—Ö –¥–≤–µ—Ä–µ–π</label>
              <input class="form-control" type="file" id="photo5" name="photo5" accept="image/*" required>
            </div>
            <div class="mb-3">
              <label for="photo6" class="form-label">–§–æ—Ç–æ –ø—Ä–∞–≤–∏—Ö –¥–≤–µ—Ä–µ–π</label>
              <input class="form-control" type="file" id="photo6" name="photo6" accept="image/*" required>
            </div>
            <div class="mb-3">
              <label for="photo7" class="form-label">–§–æ—Ç–æ –∑–∞–¥–Ω—å–æ–≥–æ –±–∞–º–ø–µ—Ä–∞ –∑ –ª—ñ–≤–∏–º –∫—Ä–∏–ª–æ–º</label>
              <input class="form-control" type="file" id="photo7" name="photo7" accept="image/*" required>
            </div>
            <div class="mb-3">
              <label for="photo8" class="form-label">–§–æ—Ç–æ –∑–∞–¥–Ω—å–æ–≥–æ –±–∞–º–ø–µ—Ä–∞ –∑ –ø—Ä–∞–≤–∏–º –∫—Ä–∏–ª–æ–º</label>
              <input class="form-control" type="file" id="photo8" name="photo8" accept="image/*" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω
  let editRentalModalInstance;

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ –ø—ñ—Å–ª—è –æ—Ä–µ–Ω–¥–∏
  function openUploadAfterPhotosModal(rentalId) {
    document.getElementById('uploadRentalId').value = rentalId;
    const uploadModalElement = document.getElementById('uploadAfterPhotosModal');
    const uploadModal = new bootstrap.Modal(uploadModalElement);
    uploadModal.show();
  }

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó —Ç–∞–±–ª–∏—Ü—ñ –æ—Ä–µ–Ω–¥ –∑–∞ —Ä—ñ–∑–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
  function searchTable() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const filterStatus = document.getElementById("statusFilter").value;
    const filterStart = document.getElementById("startDateFilter").value;
    const filterEnd = document.getElementById("endDateFilter").value;
    const rows = document.querySelectorAll("#rentalsTable tbody tr");

    rows.forEach(row => {
      const userName = row.querySelector("td:nth-child(2)").innerText.toLowerCase();
      const carLicense = row.querySelector("td:nth-child(3)").innerText.toLowerCase();
      const rentalStart = row.querySelector("td:nth-child(4)").innerText;
      const rentalEnd = row.querySelector("td:nth-child(5)").innerText;
      const rentalStatus = row.querySelector("td:nth-child(6)").innerText.toLowerCase();

      let match = userName.includes(input) || carLicense.includes(input);

      if (filterStatus !== "all") {
        match = match && rentalStatus.includes(filterStatus);
      }
      if (filterStart) {
        match = match && rentalStart.includes(filterStart);
      }
      if (filterEnd) {
        match = match && rentalEnd.includes(filterEnd);
      }

      row.style.display = match ? "" : "none";
    });
  }

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –æ—Ä–µ–Ω–¥—É
  async function openModal(rentalId) {
    try {
      const response = await fetch(`/admin/rental_details/${rentalId}`);
      if (!response.ok) throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –æ—Ä–µ–Ω–¥–∏');
      const data = await response.json();

      const rentalStart = new Date(data.rental_start).toLocaleString('uk-UA');
      const rentalEnd = new Date(data.rental_end).toLocaleString('uk-UA');

      const photosBefore = data.photos_before.map(photo =>
        `<img src="/${photo.replace(/\\/g, "/")}" alt="–§–æ—Ç–æ –¥–æ –æ—Ä–µ–Ω–¥–∏" onclick="openFullScreenPhoto('/${photo.replace(/\\/g, "/")}')"/>`
      ).join('');

      const photosAfter = data.photos_after.map(photo =>
        `<img src="/${photo.replace(/\\/g, "/")}" alt="–§–æ—Ç–æ –ø—ñ—Å–ª—è –æ—Ä–µ–Ω–¥–∏" onclick="openFullScreenPhoto('/${photo.replace(/\\/g, "/")}')"/>`
      ).join('');

      const damagesBefore = data.damages_before.map(damage =>
        `<li>${damage.damage_type} (Confidence: ${damage.confidence})</li>`
      ).join('');

      const damagesAfter = data.damages_after.map(damage =>
        `<li>${damage.damage_type} (Confidence: ${damage.confidence})</li>`
      ).join('');

      document.getElementById('rentalDetails').innerHTML = `
        <div class="rental-info">
          <p><span>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</span> ${data.user.first_name} ${data.user.last_name}</p>
          <p><span>–ê–≤—Ç–æ–º–æ–±—ñ–ª—å:</span> ${data.car.make} ${data.car.model}, ${data.car.license_plate}</p>
          <p><span>–ü–æ—á–∞—Ç–æ–∫ –æ—Ä–µ–Ω–¥–∏:</span> ${rentalStart}</p>
          <p><span>–ö—ñ–Ω–µ—Ü—å –æ—Ä–µ–Ω–¥–∏:</span> ${rentalEnd}</p>
          <p><span>–°—Ç–∞—Ç—É—Å –æ—Ä–µ–Ω–¥–∏:</span> ${data.is_ended ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–ê–∫—Ç–∏–≤–Ω–∞'}</p>
        </div>
        <div class="photo-section">
          <h6>–§–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó –¥–æ –æ—Ä–µ–Ω–¥–∏:</h6>${photosBefore}
        </div>
        <div class="damage-list">
          <h6>–ü–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –¥–æ –æ—Ä–µ–Ω–¥–∏:</h6><ul>${damagesBefore}</ul>
        </div>
        <div class="photo-section">
          <h6>–§–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó –ø—ñ—Å–ª—è –æ—Ä–µ–Ω–¥–∏:</h6>${photosAfter}
        </div>
        <div class="damage-list">
          <h6>–ü–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –ø—ñ—Å–ª—è –æ—Ä–µ–Ω–¥–∏:</h6><ul>${damagesAfter}</ul>
        </div>
      `;

      const modalFooter = document.querySelector("#rentalModal .modal-footer");
      modalFooter.innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
        ${data.damage_check && !data.is_ended && !data.has_after_photos ? `<button type="button" class="btn btn-primary ms-2" onclick="openUploadAfterPhotosModal(${rentalId})">–û–±—Å—Ç–µ–∂–∏—Ç–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</button>` : ''}
        ${!data.is_ended && data.has_new_damage ? `<button type="button" class="btn btn-danger" onclick="endRental(${rentalId})">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –æ—Ä–µ–Ω–¥—É</button>` : ''}
      `;

      const rentalModalElement = document.getElementById('rentalModal');
      const rentalModal = new bootstrap.Modal(rentalModalElement);
      rentalModal.show();

    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞:', error);
      alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–µ—Ç–∞–ª—ñ –æ—Ä–µ–Ω–¥–∏');
    }
  }

  // –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –æ—Ä–µ–Ω–¥–∏
  async function endRental(rentalId) {
    try {
      const response = await fetch(`/update_rental_end/${rentalId}`, { method: 'PATCH' });
      if (response.ok) {
        alert("‚úÖ –û—Ä–µ–Ω–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ");
        location.reload();
      } else {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ –æ—Ä–µ–Ω–¥–∏");
      }
    } catch (error) {
      console.error("–ü–æ–º–∏–ª–∫–∞:", error);
      alert("‚ùå –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è");
    }
  }

  // –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–æ—Ç–æ —É –ø–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ –∑ –º–∞–ª—é–≤–∞–Ω–Ω—è–º –ø–æ—à–∫–æ–¥–∂–µ–Ω—å
  function openFullScreenPhoto(src) {
    const canvas = document.getElementById('photoCanvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();

    img.onload = function() {
      canvas.width = img.width;
      canvas.height = img.height;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, img.width, img.height);

      fetch(`/get_damages_by_photo?photo_path=${encodeURIComponent(src)}`)
        .then(response => response.json())
        .then(damages => {
          damages.forEach(damage => {
            const box = JSON.parse(damage.box); // [x1, y1, x2, y2]
            drawBox(ctx, box, damage.damage_type);
          });
        })
        .catch(error => console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—à–∫–æ–¥–∂–µ–Ω—å:', error));
    };

    img.src = src;

    const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));
    photoModal.show();
  }

  // –§—É–Ω–∫—Ü—ñ—è –º–∞–ª—é–≤–∞–Ω–Ω—è –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∞ —ñ –ø—ñ–¥–ø–∏—Å—É –Ω–∞ canvas
  function drawBox(ctx, box, label) {
    ctx.beginPath();
    ctx.lineWidth = 3;
    ctx.strokeStyle = "red";
    ctx.rect(box[0], box[1], box[2] - box[0], box[3] - box[1]);
    ctx.stroke();

    ctx.font = "16px Arial";
    ctx.fillStyle = "red";
    ctx.fillText(label, box[0] + 5, box[1] - 5);
  }

  // –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –æ—Ä–µ–Ω–¥–∏
  function openEditModal(rentalId, currentEndDate) {
    document.getElementById('editRentalId').value = rentalId;

    if (currentEndDate) {
      const formatted = new Date(currentEndDate).toISOString().slice(0, 16); // yyyy-MM-ddThh:mm
      document.getElementById('newEndDate').value = formatted;
    }

    const modalElement = document.getElementById('editRentalModal');
    editRentalModalInstance = new bootstrap.Modal(modalElement);
    editRentalModalInstance.show();
  }

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ–¥—ñ–π –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM
  document.addEventListener('DOMContentLoaded', () => {
    // –û–±—Ä–æ–±–Ω–∏–∫ —Å–∞–±–º—ñ—Ç—É —Ñ–æ—Ä–º–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è after-—Ñ–æ—Ç–æ
    document.getElementById('uploadAfterPhotosForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const rentalId = document.getElementById('uploadRentalId').value;

      for (let i = 1; i <= 8; i++) {
        const photoInput = document.getElementById(`photo${i}`);
        if (photoInput.files.length === 0) {
          alert(`–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ç–æ ${i}`);
          return;
        }

        const formData = new FormData();
        formData.append('rental_id', rentalId);
        formData.append('user_id', '0');
        formData.append('photo_type', `after_${i}`);
        formData.append('image', photoInput.files[0], `after_${i}.jpg`);

        try {
          const resp = await fetch('/process_photo/', {
            method: 'POST',
            body: formData
          });

          if (!resp.ok) {
            throw new Error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ ${i}`);
          }
        } catch (error) {
          alert(error.message);
          console.error(error);
          return;
        }
      }

      alert('–§–æ—Ç–æ –ø—ñ—Å–ª—è –æ—Ä–µ–Ω–¥–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ!');
      const modalInstance = bootstrap.Modal.getInstance(document.getElementById('uploadAfterPhotosModal'));
      modalInstance.hide();
      location.reload();
    });

    // –û–±—Ä–æ–±–Ω–∏–∫ —Å–∞–±–º—ñ—Ç—É —Ñ–æ—Ä–º–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –æ—Ä–µ–Ω–¥–∏
    document.getElementById('editRentalForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const rentalId = document.getElementById('editRentalId').value;
      const newEndDate = document.getElementById('newEndDate').value;

      try {
        const response = await fetch(`/admin/update_rental_data_end/${rentalId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ rental_end: newEndDate })
        });

        if (response.ok) {
          location.reload();
        } else {
          alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Ä–µ–Ω–¥–∏!');
        }
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞');
      }
    });
  });

  // –ü—Ä–∏–≤'—è–∑—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó —É –≥–ª–æ–±–∞–ª—å–Ω—É –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—ñ (—â–æ–± –≤–∏–∫–ª–∏–∫–∏ –∑ onclick –ø—Ä–∞—Ü—é–≤–∞–ª–∏)
  window.openUploadAfterPhotosModal = openUploadAfterPhotosModal;
  window.openModal = openModal;
  window.endRental = endRental;
  window.openFullScreenPhoto = openFullScreenPhoto;
  window.openEditModal = openEditModal;
  window.searchTable = searchTable;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
